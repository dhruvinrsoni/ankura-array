<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ankura-Array ‚Äî Garden of Apps</title>
    <meta
      name="description"
      content="A robust, offline-first platform for hosting static Nano Applications."
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <header class="site-header">
      <h1><span class="accent">Ankura</span>-Array</h1>
      <p>Garden of Apps &mdash; Done and Dusted.</p>
      <select id="theme-select" title="Theme" style="position:absolute;right:1rem;top:1rem;padding:0.35rem 0.6rem;">
        <option value="auto">Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </header>

    <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <main class="main-content">
      <div class="section-label">Nano Applications</div>
      <div id="app-grid" class="app-grid">
        <!-- Cards rendered by script below -->
      </div>
      <div id="empty-state" class="empty-state" hidden>
        No applications registered. Add entries to
        <code>app_registry.js</code> to get started.
      </div>

      <!-- ‚îÄ‚îÄ Instance Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="instance-manager" class="instance-manager" hidden>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <div class="section-label">Instance Storage & Cleanup</div>
          <button id="btn-toggle-instances" class="btn btn--outline" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
            ‚úï Hide
          </button>
        </div>

        <div id="instances-list" class="instances-list">
          <!-- Instance items rendered by script -->
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <button id="btn-reset-all" class="btn btn--danger" style="width: 100%;">
            üóëÔ∏è Reset & Clean Up Everything
          </button>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">
            Wipes all instance data and localStorage. Use with caution.
          </p>
        </div>
      </div>
    </main>

    <!-- ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <footer class="site-footer">
      Ankura-Array &middot; Zero dependencies &middot; Works offline
    </footer>

    <!-- ‚îÄ‚îÄ Registry (Protocol A: Script-Injection) ‚îÄ‚îÄ -->
    <script src="app_registry.js"></script>

    <!-- ‚îÄ‚îÄ Dashboard Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <script>
      (function () {
        "use strict";

        // Instance identity for dashboard (so theme preference is instance-isolated)
        function initInstanceId() {
          var params = new URLSearchParams(window.location.search);
          var id = params.get("instanceId");
          if (id) {
            sessionStorage.setItem("ankura_instanceId", id);
            return id;
          }
          id = sessionStorage.getItem("ankura_instanceId");
          if (id) return id;
          id = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'inst-' + Math.random().toString(36).slice(2,9);
          sessionStorage.setItem("ankura_instanceId", id);
          var newUrl = window.location.pathname + "?instanceId=" + id + window.location.hash;
          try { window.history.replaceState(null, "", newUrl); } catch (e) {}
          return id;
        }

        var DASH_INSTANCE_ID = initInstanceId();

        function applyThemeMode(mode) {
          var value = mode || 'auto';
          var useDark = false;
          if (value === 'auto') {
            try { useDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(e) { useDark = false; }
          } else if (value === 'dark') useDark = true;
          else useDark = false;
          document.body.classList.toggle('dark-theme', useDark);
          document.body.classList.toggle('light-theme', !useDark);
        }

        // Theme selector (per-instance)
        (function themeSetup(){
          var sel = document.getElementById('theme-select');
          if (!sel) return;
          var key = DASH_INSTANCE_ID + '__theme';
          var saved = null;
          try { saved = localStorage.getItem(key); } catch(e){}
          var cur = saved || 'auto';
          try { sel.value = cur; } catch (e) {}
          applyThemeMode(cur);
          sel.addEventListener('change', function(){
            var v = sel.value || 'auto';
            try { localStorage.setItem(key, v); } catch(e){}
            applyThemeMode(v);
          });
        })();

        const grid = document.getElementById("app-grid");
        const emptyState = document.getElementById("empty-state");
        const registry = window.ANKURA_REGISTRY || [];

        if (!registry.length) {
          emptyState.hidden = false;
          return;
        }

        registry.forEach(function (app) {
          const card = document.createElement("article");
          card.className = "app-card";
          card.innerHTML =
            '<div class="app-card__icon">' +
            escapeHTML(app.icon || "üì¶") +
            "</div>" +
            '<h2 class="app-card__name">' +
            escapeHTML(app.name) +
            "</h2>" +
            '<p class="app-card__desc">' +
            escapeHTML(app.description) +
            "</p>" +
            (app.version
              ? '<span class="app-card__version">v' +
                escapeHTML(app.version) +
                "</span>"
              : "") +
            '<button class="app-card__launch" data-path="' +
            escapeHTML(app.path) +
            '">&#9654; Launch</button>';

          card
            .querySelector(".app-card__launch")
            .addEventListener("click", function () {
              launchApp(app.path);
            });

          grid.appendChild(card);
        });

        /**
         * Generate a UUID and open the app in a new tab with ?instanceId=UUID.
         */
        function launchApp(appPath) {
          var instanceId =
            typeof crypto.randomUUID === "function"
              ? crypto.randomUUID()
              : fallbackUUID();
          var separator = appPath.indexOf("?") === -1 ? "?" : "&";
          var url = appPath + separator + "instanceId=" + instanceId;
          window.open(url, "_blank");
        }

        /**
         * Fallback UUID v4 generator for older browsers / insecure contexts.
         */
        function fallbackUUID() {
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0;
              var v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        }

        /**
         * Basic HTML escaping to prevent injection.
         */
        function escapeHTML(str) {
          var div = document.createElement("div");
          div.appendChild(document.createTextNode(str));
          return div.innerHTML;
        }

        /* ‚îÄ‚îÄ Instance Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

        /**
         * Enumerate all unique instanceIds from localStorage.
         * Returns { instanceId, apps: [list of app ids with data for this instance] }[]
         */
        function getInstanceRegistry() {
          var instances = {};  // instanceId ‚Üí { apps: Set }
          try {
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (!key) continue;
              // Look for pattern: {UUID}__* or {inst-XXXX}__*
              var match = key.match(/^([a-f0-9-]+|inst-[a-z0-9]+)__(.+)$/);
              if (!match) continue;
              var instanceId = match[1];
              var dataKey = match[2];
              // Detect which app owns this data
              var appId = null;
              if (dataKey.includes("yukti")) appId = "genai-yukti-deck";
              else appId = "vaak-smith";  // default to omdat-smith for generic keys
              if (!instances[instanceId]) {
                instances[instanceId] = { apps: new Set() };
              }
              instances[instanceId].apps.add(appId);
            }
          } catch (e) {}
          // Convert Sets to Arrays and sort
          var result = Object.keys(instances).map(function (id) {
            return {
              instanceId: id,
              apps: Array.from(instances[id].apps).sort(),
            };
          }).sort(function (a, b) {
            return a.instanceId.localeCompare(b.instanceId);
          });
          return result;
        }

        /**
         * Delete all localStorage keys for a given instanceId.
         */
        function deleteInstance(instanceId) {
          if (!confirm("Delete all data for instance " + instanceId + "?")) return;
          try {
            var keysToDelete = [];
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (key && key.startsWith(instanceId + "__")) {
                keysToDelete.push(key);
              }
            }
            keysToDelete.forEach(function (key) {
              localStorage.removeItem(key);
            });
          } catch (e) {}
          renderInstanceManager();
        }

        /**
         * Delete ALL localStorage (nuclear option).
         */
        function resetEverything() {
          if (!confirm("Permanently delete ALL instance data? This cannot be undone.")) return;
          if (!confirm("Really? Type YES to confirm...")) return;
          try {
            localStorage.clear();
          } catch (e) {}
          renderInstanceManager();
        }

        /**
         * Open an instance of a specific app.
         */
        function openInstance(instanceId, appId) {
          var app = registry.find(function (a) { return a.id === appId; });
          if (!app) return;
          var separator = app.path.indexOf("?") === -1 ? "?" : "&";
          var url = app.path + separator + "instanceId=" + encodeURIComponent(instanceId);
          window.open(url, "_blank");
        }

        /**
         * Render the instance manager list.
         */
        function renderInstanceManager() {
          var manager = document.getElementById("instance-manager");
          var list = document.getElementById("instances-list");
          if (!manager || !list) return;

          var instances = getInstanceRegistry();
          if (instances.length === 0) {
            manager.hidden = true;
            return;
          }

          manager.hidden = false;
          list.innerHTML = "";

          instances.forEach(function (inst) {
            var el = document.createElement("div");
            el.className = "instance-item";

            var infoHTML =
              '<div class="instance-item__id">ID: ' + escapeHTML(inst.instanceId) + '</div>' +
              '<div class="instance-item__apps">' +
              inst.apps.map(function (appId) {
                return '<span class="instance-item__app-tag">' + escapeHTML(appId) + '</span>';
              }).join('') +
              '</div>';

            var actionsHTML =
              inst.apps.map(function (appId) {
                return '<button class="btn btn--outline" data-instance="' +
                  escapeHTML(inst.instanceId) +
                  '" data-app="' + escapeHTML(appId) + '">Open</button>';
              }).join('') +
              '<button class="btn btn--danger" data-delete="' +
              escapeHTML(inst.instanceId) +
              '">Delete</button>';

            el.innerHTML =
              '<div class="instance-item__info">' + infoHTML + '</div>' +
              '<div class="instance-item__actions">' + actionsHTML + '</div>';

            // Event: Open
            el.querySelectorAll('[data-instance]').forEach(function (btn) {
              btn.addEventListener('click', function () {
                openInstance(btn.getAttribute('data-instance'), btn.getAttribute('data-app'));
              });
            });

            // Event: Delete
            el.querySelectorAll('[data-delete]').forEach(function (btn) {
              btn.addEventListener('click', function () {
                deleteInstance(btn.getAttribute('data-delete'));
              });
            });

            list.appendChild(el);
          });
        }

        // Setup instance manager UI
        (function initInstanceManager() {
          var toggleBtn = document.getElementById("btn-toggle-instances");
          var resetBtn = document.getElementById("btn-reset-all");
          if (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
              var manager = document.getElementById("instance-manager");
              manager.hidden = !manager.hidden;
              toggleBtn.textContent = manager.hidden ? "‚úï Show" : "‚úï Hide";
            });
          }
          if (resetBtn) {
            resetBtn.addEventListener('click', resetEverything);
          }
          renderInstanceManager();
        })();
      })();
    </script>
  </body>
</html>
