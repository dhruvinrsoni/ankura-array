<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ankura-Array ‚Äî Garden of Apps</title>
    <meta
      name="description"
      content="A robust, offline-first platform for hosting static Nano Applications."
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body><script>!function(){try{var v=localStorage.getItem('ankura_theme')||'auto';var d=v==='dark'||(v==='auto'&&window.matchMedia('(prefers-color-scheme:dark)').matches);document.body.classList.toggle('dark-theme',d);document.body.classList.toggle('light-theme',!d)}catch(e){}}()</script>
    <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <header class="site-header">
      <h1><span class="accent">Ankura</span>-Array</h1>
      <p>Garden of Apps &mdash; Done and Dusted.</p>
      <select id="theme-select" class="site-header__theme-select" title="Theme">
        <option value="auto">Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </header>

    <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <main class="main-content">
      <div class="section-row">
        <div class="section-label">Nano Applications</div>
        <input
          id="search-apps"
          type="text"
          class="search-input"
          placeholder="Type to search (prompt, AI, hacks, prompting...)"
          autocomplete="off"
        />
      </div>
      <div id="app-grid" class="app-grid">
        <!-- Cards rendered by script below -->
      </div>
      <div id="empty-state" class="empty-state" hidden>
        No applications registered. Add entries to
        <code>app_registry.js</code> to get started.
      </div>
      <div id="no-results" class="empty-state" hidden>
        No apps match your search. Try different keywords.
      </div>

      <!-- ‚îÄ‚îÄ Instance Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="instance-manager" class="instance-manager" hidden>
        <div class="section-row section-row--compact">
          <div class="section-label">Instance Storage & Cleanup</div>
          <button id="btn-toggle-instances" class="btn btn--outline btn--sm">
            ‚úï Hide
          </button>
        </div>

        <div id="instances-list" class="instances-list">
          <!-- Instance items rendered by script -->
        </div>

        <div class="divider">
          <div class="section-label">Per-App Cleanup</div>
          <div id="per-app-cleanup-grid" class="cleanup-grid">
            <!-- populated dynamically from ANKURA_REGISTRY, only for apps with data -->
          </div>

          <div class="divider divider--flush">
            <button id="btn-reset-all" class="btn btn--danger btn--full">
              üóëÔ∏è Reset & Clean Up Everything
            </button>
          </div>
          <p class="help-text">
            Wipes all instance data and localStorage. Use with caution.
          </p>
        </div>
      </div>
    </main>

    <!-- ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <footer class="site-footer">
      Ankura-Array &middot; Zero dependencies &middot; Works offline
    </footer>

    <!-- ‚îÄ‚îÄ Registry (Protocol A: Script-Injection) ‚îÄ‚îÄ -->
    <script src="app_registry.js"></script>

    <!-- ‚îÄ‚îÄ Dashboard Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <script>
      (function () {
        "use strict";

        // Note: Dashboard doesn't need instanceId‚Äîonly individual apps do.
        // (instanceId is for isolating state in Vast-Smith, GenAI-Yukti-Deck, etc.)
        // The dashboard is just a launcher.

        function applyThemeMode(mode) {
          var value = mode || 'auto';
          var useDark = false;
          if (value === 'auto') {
            try { useDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(e) { useDark = false; }
          } else if (value === 'dark') useDark = true;
          else useDark = false;
          document.body.classList.toggle('dark-theme', useDark);
          document.body.classList.toggle('light-theme', !useDark);
        }

        // Theme selector (global preference)
        (function themeSetup(){
          var sel = document.getElementById('theme-select');
          if (!sel) return;
          var key = 'ankura_theme';
          var saved = null;
          try { saved = localStorage.getItem(key); } catch(e){}
          var cur = saved || 'auto';
          try { sel.value = cur; } catch (e) {}
          applyThemeMode(cur);
          sel.addEventListener('change', function(){
            var v = sel.value || 'auto';
            try { localStorage.setItem(key, v); } catch(e){}
            applyThemeMode(v);
          });
        })();

        const grid = document.getElementById("app-grid");
        const emptyState = document.getElementById("empty-state");
        const noResults = document.getElementById("no-results");
        const searchInput = document.getElementById("search-apps");
        const registry = window.ANKURA_REGISTRY || [];

        // ‚îÄ‚îÄ Shared helpers (used by renderApps + renderInstanceManager) ‚îÄ‚îÄ

        function timeAgo(d) {
          if (!d) return '‚Äî';
          var s = Math.floor((Date.now() - d.getTime()) / 1000);
          if (s < 5) return 'now';
          if (s < 60) return s + 's';
          var m = Math.floor(s / 60);
          if (m < 60) return m + 'm';
          var h = Math.floor(m / 60);
          if (h < 24) return h + 'h';
          var days = Math.floor(h / 24);
          return days + 'd';
        }

        function parseInstanceMeta(instanceId) {
          var rawC = null, rawU = null;
          try { rawC = localStorage.getItem(instanceId + '__meta_created'); } catch (e) {}
          try { rawU = localStorage.getItem(instanceId + '__meta_updated'); } catch (e) {}
          var isoC = rawC, isoU = rawU;
          try { isoC = JSON.parse(rawC); } catch (e) {}
          try { isoU = JSON.parse(rawU); } catch (e) {}
          var dC = null, dU = null;
          try { dC = isoC ? new Date(isoC) : (rawC ? new Date(rawC) : null); } catch (e) { dC = null; }
          try { dU = isoU ? new Date(isoU) : (rawU ? new Date(rawU) : null); } catch (e) { dU = null; }
          return { isoCreated: isoC || rawC, isoUpdated: isoU || rawU, created: dC, updated: dU };
        }

        if (!registry.length) {
          emptyState.hidden = false;
          return;
        }

        /**
         * Render apps based on current search filter.
         */
        function renderApps(filteredApps) {
          grid.innerHTML = "";
          var appsToShow = filteredApps || registry;

          if (appsToShow.length === 0) {
            grid.hidden = true;
            noResults.hidden = false;
            return;
          }

          grid.hidden = false;
          noResults.hidden = true;

          appsToShow.forEach(function (app) {
            var instances = getInstanceRegistry();
            // Find instances that include this app
            var instancesForApp = instances.filter(function (it) { return (it.apps || []).indexOf(app.id) !== -1; });

            // Build instance meta list
            var instMeta = instancesForApp.map(function (it) {
              var meta = parseInstanceMeta(it.instanceId);
              return { instanceId: it.instanceId, updated: meta.updated, created: meta.created, isoUpdated: meta.isoUpdated, isoCreated: meta.isoCreated };
            }).filter(function (m) { return m.updated || m.created; });

            // Determine latest updated across instances
            var latest = null;
            instMeta.forEach(function (m) {
              if (!m.updated) return;
              if (!latest || m.updated > latest.updated) latest = m;
            });

            var rel = latest && latest.updated ? timeAgo(latest.updated) : null;

            const card = document.createElement("article");
            card.className = "app-card";
            card.innerHTML =
              '<div class="app-card__icon">' + escapeHTML(app.icon || "üì¶") + '</div>' +
              '<div class="app-card__name-row">' +
                '<h2 class="app-card__name">' + escapeHTML(app.name) + '</h2>' +
                (app.shortForm ? '<span class="app-card__short-form">' + escapeHTML(app.shortForm) + '</span>' : '') +
              '</div>' +
              '<p class="app-card__desc">' + escapeHTML(app.description) + '</p>' +
              (app.version ? '<span class="app-card__version">v' + escapeHTML(app.version) + '</span>' : '') +
              (rel ? '<span class="app-card__meta" title="Updated: ' + (latest ? (latest.isoUpdated || '') : '') + '\nCreated: ' + (latest ? (latest.isoCreated || '') : '') + '\nAbsolute: ' + (latest && latest.updated ? latest.updated.toLocaleString() : '') + '">Updated: ' + rel + '</span>' : '') +
              '<button class="app-card__expand btn btn--outline btn--sm">Instances</button>' +
              '<button class="app-card__launch" data-path="' + escapeHTML(app.path) + '">&#9654; Launch</button>' +
              '<div class="app-card__instances" hidden></div>';

            // Launch handler
            card.querySelector('.app-card__launch').addEventListener('click', function () { launchApp(app.path); });

            // Expand instances handler
            var expBtn = card.querySelector('.app-card__expand');
            var instContainer = card.querySelector('.app-card__instances');
            expBtn.addEventListener('click', function () {
              if (instContainer.hidden) {
                // populate list
                instContainer.innerHTML = '';
                if (instMeta.length === 0) {
                  instContainer.textContent = 'No instances with metadata found.';
                } else {
                  var list = document.createElement('div');
                  instMeta.sort(function(a,b){ var ta = a.updated ? a.updated.getTime() : 0; var tb = b.updated ? b.updated.getTime() : 0; return tb - ta; });
                  instMeta.forEach(function (m) {
                    var row = document.createElement('div');
                    row.className = 'instance-row';
                    var idSpan = document.createElement('span'); idSpan.textContent = m.instanceId.slice(0,8) + (m.instanceId.length>8? '‚Ä¶':''); idSpan.title = m.instanceId;
                    var timeSpan = document.createElement('span'); timeSpan.textContent = (m.updated ? timeAgo(m.updated) : (m.created ? 'created' : '‚Äî'));
                    timeSpan.title = 'Updated: ' + (m.isoUpdated || '') + '\nCreated: ' + (m.isoCreated || '') + '\nLocal: ' + (m.updated ? (m.updated.toLocaleString()) : (m.created ? (m.created.toLocaleString()) : ''));
                    var openBtn = document.createElement('button'); openBtn.className = 'btn btn--outline btn--sm'; openBtn.textContent = 'Open';
                    openBtn.addEventListener('click', function () { var sep = app.path.indexOf('?')===-1 ? '?' : '&'; window.open(app.path + sep + 'instanceId=' + encodeURIComponent(m.instanceId), '_blank'); });
                    row.appendChild(idSpan); row.appendChild(timeSpan); row.appendChild(openBtn);
                    list.appendChild(row);
                  });
                  instContainer.appendChild(list);
                }
                instContainer.hidden = false;
                expBtn.textContent = 'Hide Instances';
              } else {
                instContainer.hidden = true;
                expBtn.textContent = 'Instances';
              }
            });

            grid.appendChild(card);
          });
        }

        /**
         * Smart search with scoring and relevance ranking.
         * 
         * Features:
         *   - Space-separated keywords (AND logic: all must match)
         *   - Field weighting: name (10x) > description (2x) > tags (2x)
         *   - Substring matching for flexibility
         *   - Results sorted by relevance (highest score first)
         *   - Handles partial word matches
         */
        function filterApps(searchTerm) {
          if (!searchTerm || searchTerm.trim() === "") {
            return registry;
          }

          var keywords = searchTerm
            .toLowerCase()
            .trim()
            .split(/\s+/)
            .filter(function (k) { return k.length > 0; });

          if (keywords.length === 0) {
            return registry;
          }

          /**
           * Score a single keyword against an app's field.
           * Returns score (0 if no match, higher for better matches).
           */
          function scoreKeywordInField(keyword, field) {
            if (!field || field.length === 0) return 0;
            var lowerField = field.toLowerCase();
            var lowerKeyword = keyword.toLowerCase();

            // Exact match (entire field equals keyword)
            if (lowerField === lowerKeyword) return 100;

            // Starts with keyword (high relevance)
            if (lowerField.startsWith(lowerKeyword)) return 50;

            // Word boundary match (keyword starts a word in the field)
            try {
              var escaped = lowerKeyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              var wordBoundaryMatch = new RegExp("(^|\\s|-)" + escaped);
              if (wordBoundaryMatch.test(lowerField)) return 30;
            } catch (e) {}

            // Substring match (keyword appears anywhere)
            if (lowerField.includes(lowerKeyword)) return 10;

            return 0;
          }

          /**
           * Score an app against ALL keywords.
           * Returns total score. Score is 0 if ANY keyword doesn't match.
           */
          function scoreApp(app) {
            var name = (app.name || "").toLowerCase();
            var shortForm = (app.shortForm || "").toLowerCase();
            var desc = (app.description || "").toLowerCase();
            var tagsStr = (app.tags || [])
              .map(function (t) { return t.toLowerCase(); })
              .join(" ");

            var totalScore = 0;

            // For each keyword, it must match something
            for (var i = 0; i < keywords.length; i++) {
              var keyword = keywords[i];
              var nameScore = scoreKeywordInField(keyword, name);
              var shortFormScore = scoreKeywordInField(keyword, shortForm);
              var descScore = scoreKeywordInField(keyword, desc);
              var tagsScore = scoreKeywordInField(keyword, tagsStr);

              // Weight the scores: name and shortForm are most important
              var keywordScore = Math.max(
                nameScore * 10,      // name matches are worth 10x
                shortFormScore * 10, // shortForm matches (VS, GD) are worth 10x
                descScore * 2,       // description matches are worth 2x
                tagsScore * 2        // tags matches are worth 2x
              );

              // If this keyword doesn't match anywhere, the app is out
              if (keywordScore === 0) {
                return 0;
              }

              totalScore += keywordScore;
            }

            return totalScore;
          }

          // Score all apps and filter out zeros
          var scored = registry.map(function (app) {
            return { app: app, score: scoreApp(app) };
          });

          // Filter to only matching apps and sort by score (descending)
          return scored
            .filter(function (item) { return item.score > 0; })
            .sort(function (a, b) { return b.score - a.score; })
            .map(function (item) { return item.app; });
        }

        // Setup search input listener
        if (searchInput) {
          searchInput.addEventListener("input", function () {
            var filtered = filterApps(searchInput.value);
            renderApps(filtered);
          });
        }

        // Initial render
        renderApps(registry);

        /**
         * Generate a UUID and open the app in a new tab with ?instanceId=UUID.
         */
        function launchApp(appPath) {
          var instanceId =
            typeof crypto.randomUUID === "function"
              ? crypto.randomUUID()
              : fallbackUUID();
          var separator = appPath.indexOf("?") === -1 ? "?" : "&";
          var url = appPath + separator + "instanceId=" + instanceId;
          window.open(url, "_blank");
        }

        /**
         * Fallback UUID v4 generator for older browsers / insecure contexts.
         */
        function fallbackUUID() {
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0;
              var v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        }

        /**
         * Basic HTML escaping to prevent injection.
         */
        function escapeHTML(str) {
          var div = document.createElement("div");
          div.appendChild(document.createTextNode(str));
          return div.innerHTML;
        }

        /* ‚îÄ‚îÄ Instance Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

        /**
         * Enumerate all unique instanceIds from localStorage.
         * Returns { instanceId, apps: [list of app ids with data for this instance] }[]
         */
        function getInstanceRegistry() {
          var instances = {}; // instanceId -> { apps: Set }
          try {
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (!key) continue;
              var match = key.match(/^([a-f0-9-]+|inst-[a-z0-9]+)__(.+)$/);
              if (!match) continue;
              var instanceId = match[1];
              var dataKey = match[2] || '';
              if (!instances[instanceId]) instances[instanceId] = { apps: new Set() };

              // Heuristics to detect app ownership:
              // - If any key contains 'yukti' it's GenAI-Yukti-Deck
              // - If any key contains 'VAAK_GLOBAL' or 'FRAMEWORK' or 'userPrompt' or 'system' it's Vaak-Smith
              // - If both present, include both apps for that instance
              var dk = dataKey.toLowerCase();
              if (dk.indexOf('yukti') !== -1) instances[instanceId].apps.add('genai-yukti-deck');
              if (dk.indexOf('vaak') !== -1) instances[instanceId].apps.add('vaak-smith');
              if (dk.indexOf('gati') !== -1 || dk.indexOf('gati_tickets') !== -1) instances[instanceId].apps.add('gati-grid');
              if (dk.indexOf('tb_tools') !== -1 || dk.indexOf('tb_events') !== -1 ||
                  dk.indexOf('tb_last_tool') !== -1) {
                instances[instanceId].apps.add('tula-bench');
              }
              if (dk.indexOf('framework_instance') !== -1 || dk.indexOf('framework_sections') !== -1 || dk.indexOf('userprompt') !== -1 || dk.indexOf('system') !== -1 || dk.indexOf('vaak_global') !== -1) {
                instances[instanceId].apps.add('vaak-smith');
              }
              // If dataKey is meta_* and we've not detected ownership yet, we will defer; presence of other keys will assign apps.
            }

            // Second pass: for instances that still have empty apps sets, try to infer from any key prefixes
            for (var j = 0; j < localStorage.length; j++) {
              var k = localStorage.key(j);
              if (!k) continue;
              var m = k.match(/^([a-f0-9-]+|inst-[a-z0-9]+)__(.+)$/);
              if (!m) continue;
              var iid = m[1];
              if (!instances[iid]) continue;
              if (instances[iid].apps.size > 0) continue;
              var full = k.toLowerCase();
              if (full.indexOf('yukti') !== -1) instances[iid].apps.add('genai-yukti-deck');
              else if (full.indexOf('gati') !== -1 || full.indexOf('gati_tickets') !== -1) instances[iid].apps.add('gati-grid');
              else instances[iid].apps.add('vaak-smith');
            }
          } catch (e) {}

          var result = Object.keys(instances).map(function (id) {
            return { instanceId: id, apps: Array.from(instances[id].apps).sort() };
          }).sort(function (a, b) { return a.instanceId.localeCompare(b.instanceId); });
          return result;
        }

        /**
         * Delete all localStorage keys for a given instanceId.
         */
        function deleteInstance(instanceId) {
          if (!confirm("Delete all data for instance " + instanceId + "?")) return;
          try {
            var keysToDelete = [];
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (key && key.startsWith(instanceId + "__")) {
                keysToDelete.push(key);
              }
            }
            keysToDelete.forEach(function (key) {
              localStorage.removeItem(key);
            });
          } catch (e) {}
          renderInstanceManager();
        }

        /**
         * Returns true if a localStorage key belongs to a given appId.
         * Mirrors the heuristics in getInstanceRegistry() ‚Äî must stay in sync.
         */
        function keyBelongsToApp(key, appId) {
          var dk = key.toLowerCase();
          if (appId === 'genai-yukti-deck') return dk.indexOf('yukti') !== -1;
          if (appId === 'gati-grid')        return dk.indexOf('gati') !== -1;
          if (appId === 'tula-bench')       return dk.indexOf('__tb_') !== -1 || dk.indexOf('tb_tools') !== -1 || dk.indexOf('tb_events') !== -1 || dk.indexOf('tb_last_tool') !== -1;
          // vaak-smith: catch-all ‚Äî anything not claimed by the above apps
          return dk.indexOf('yukti') === -1 && dk.indexOf('gati') === -1 &&
                 dk.indexOf('__tb_') === -1 && dk.indexOf('tb_tools') === -1 &&
                 dk.indexOf('tb_events') === -1 && dk.indexOf('tb_last_tool') === -1;
        }

        /**
         * Delete all data for a specific app across all instances.
         */
        function deleteAppData(appId) {
          var app = registry.find(function (a) { return a.id === appId; });
          var appName = app ? app.name : appId;
          if (!confirm("Delete all " + appName + " data across all instances?")) return;
          try {
            var keysToDelete = [];
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (!key || key.indexOf('__') === -1) continue;
              if (keyBelongsToApp(key, appId)) keysToDelete.push(key);
            }
            keysToDelete.forEach(function (key) { localStorage.removeItem(key); });
          } catch (e) {}
          renderInstanceManager();
        }

        /**
         * Delete ALL localStorage (nuclear option).
         */
        function resetEverything() {
          if (!confirm("Permanently delete ALL instance data? This cannot be undone.")) return;
          if (!confirm("Really?")) return;
          try {
            localStorage.clear();
          } catch (e) {}
          renderInstanceManager();
        }

        /**
         * Open an instance of a specific app.
         */
        function openInstance(instanceId, appId) {
          var app = registry.find(function (a) { return a.id === appId; });
          if (!app) return;
          var separator = app.path.indexOf("?") === -1 ? "?" : "&";
          var url = app.path + separator + "instanceId=" + encodeURIComponent(instanceId);
          window.open(url, "_blank");
        }

        /**
         * Render the instance manager list.
         */
        function renderInstanceManager() {
          var manager = document.getElementById("instance-manager");
          var list = document.getElementById("instances-list");
          if (!manager || !list) return;

          var instances = getInstanceRegistry();
          if (instances.length === 0) {
            manager.hidden = true;
            return;
          }

          manager.hidden = false;
          list.innerHTML = "";

          instances.forEach(function (inst) {
            var el = document.createElement("div");
            el.className = "instance-item";
              // collect meta timestamps for this instance
              var meta = parseInstanceMeta(inst.instanceId);
              var isoC = meta.isoCreated, isoU = meta.isoUpdated;
              var dC = meta.created, dU = meta.updated;

              var shortId = inst.instanceId && inst.instanceId.length > 8 ? (inst.instanceId.slice(0,8) + '‚Ä¶') : inst.instanceId;
              var infoHTML =
                  '<div class="instance-item__id" title="' + escapeHTML(inst.instanceId) + '">' + escapeHTML(shortId) + '</div>' +
                  '<div class="instance-item__apps">' +
                  inst.apps.map(function (appId) {
                    return '<span class="instance-item__app-tag">' + escapeHTML(appId) + '</span>';
                  }).join('') +
                  '</div>';

            var actionsHTML =
              inst.apps.map(function (appId) {
                return '<button class="btn btn--outline" data-instance="' +
                  escapeHTML(inst.instanceId) +
                  '" data-app="' + escapeHTML(appId) + '">Open</button>';
              }).join('') +
              '<button class="btn btn--danger" data-delete="' +
              escapeHTML(inst.instanceId) +
              '">Delete</button>';

            el.innerHTML =
              '<div class="instance-item__left">' + infoHTML + '</div>' +
              '<div class="instance-item__right">' +
                '<div class="instance-item__ts">' +
                  'Updated: <span title="' + (isoU || '') + '\nCreated: ' + (isoC || '') + '">' + (dU ? timeAgo(dU) : (dC ? 'created' : '‚Äî')) + '</span>' +
                '</div>' +
                '<div class="instance-item__actions">' + actionsHTML + '</div>' +
              '</div>';

            // Event: Open
            el.querySelectorAll('[data-instance]').forEach(function (btn) {
              btn.addEventListener('click', function () {
                openInstance(btn.getAttribute('data-instance'), btn.getAttribute('data-app'));
              });
            });

            // Event: Delete
            el.querySelectorAll('[data-delete]').forEach(function (btn) {
              btn.addEventListener('click', function () {
                deleteInstance(btn.getAttribute('data-delete'));
              });
            });

            list.appendChild(el);
          });
        }

        // Setup instance manager UI
        (function initInstanceManager() {
          var toggleBtn = document.getElementById("btn-toggle-instances");
          var resetBtn = document.getElementById("btn-reset-all");

          if (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
              var manager = document.getElementById("instance-manager");
              manager.hidden = !manager.hidden;
              toggleBtn.textContent = manager.hidden ? "‚úï Show" : "‚úï Hide";
            });
          }

          // Generate Per-App Cleanup buttons dynamically from registry.
          // Only show a button if that app actually has data in localStorage.
          var cleanupGrid = document.getElementById('per-app-cleanup-grid');
          if (cleanupGrid) {
            cleanupGrid.innerHTML = '';
            registry.forEach(function (app) {
              // Check if any key in localStorage belongs to this app
              var hasData = false;
              try {
                for (var i = 0; i < localStorage.length; i++) {
                  var k = localStorage.key(i);
                  if (k && k.indexOf('__') !== -1 && keyBelongsToApp(k, app.id)) { hasData = true; break; }
                }
              } catch (e) {}
              if (!hasData) return;
              var btn = document.createElement('button');
              btn.className = 'btn btn--danger btn--sm';
              btn.textContent = (app.icon || '') + ' Clear ' + app.name;
              btn.addEventListener('click', (function (id) {
                return function () { deleteAppData(id); refreshCleanupGrid(); };
              })(app.id));
              cleanupGrid.appendChild(btn);
            });
          }

          function refreshCleanupGrid() {
            if (!cleanupGrid) return;
            cleanupGrid.innerHTML = '';
            registry.forEach(function (app) {
              var hasData = false;
              try {
                for (var i = 0; i < localStorage.length; i++) {
                  var k = localStorage.key(i);
                  if (k && k.indexOf('__') !== -1 && keyBelongsToApp(k, app.id)) { hasData = true; break; }
                }
              } catch (e) {}
              if (!hasData) return;
              var btn = document.createElement('button');
              btn.className = 'btn btn--danger btn--sm';
              btn.textContent = (app.icon || '') + ' Clear ' + app.name;
              btn.addEventListener('click', (function (id) {
                return function () { deleteAppData(id); refreshCleanupGrid(); };
              })(app.id));
              cleanupGrid.appendChild(btn);
            });
          }

          if (resetBtn) {
            resetBtn.addEventListener('click', resetEverything);
          }
          renderInstanceManager();
        })();
      })();
    </script>

    <!-- ‚îÄ‚îÄ Version badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <footer class="version-footer">
      <span id="version-badge" class="version-footer__badge">
        <!-- populated by version fetch below -->
      </span>
    </footer>
    <script>
      (function () {
        var badge = document.getElementById('version-badge');
        if (!badge) return;
        fetch('./version.json')
          .then(function (r) { return r.json(); })
          .then(function (v) {
            badge.textContent = v.sha + ' ¬∑ ' + (v.date || '').slice(0, 10);
            badge.title = 'Deployed commit: ' + v.sha + '\n' + v.date;
          })
          .catch(function () { /* not available on file:// */ });
      })();
    </script>
  </body>
</html>
